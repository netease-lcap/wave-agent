# Data Model: Session Management

## Directory Structure

Sessions are organized in the following hierarchy:

```
~/.wave/projects/
├── -home-user-project-a/
│   ├── 550e8400-e29b-41d4-a716-446655440000.jsonl (Main Session)
│   └── subagent-e4e16349-74bf-406a-80e5-53a593591930.jsonl (Subagent Session)
└── -var-www-html-my-site/
    └── ...
```

### Path Encoding
The project directory name is generated by `PathEncoder`:
1. Resolve symbolic links.
2. Replace `/` with `-`.
3. Replace special characters (spaces, quotes, etc.) with safe strings (e.g., `_`, `sq-quote`).
4. If the result exceeds 200 characters, truncate and append a SHA-256 hash suffix.

## File Format (JSONL)

Each session file is a JSONL file where each line is a `SessionMessage`.

### SessionMessage
Extends the base `Message` type with a timestamp.

```typescript
interface SessionMessage extends Message {
  timestamp: string; // ISO 8601 format
}
```

## Interfaces

### SessionData
The full data structure returned when loading a session.

```typescript
export interface SessionData {
  id: string;
  rootSessionId: string; // The ID of the first session in the chain
  messages: Message[];
  metadata: {
    workdir: string;
    lastActiveAt: string;
    latestTotalTokens: number;
  };
}
```

### SessionMetadata
The lightweight structure used for listing sessions.

```typescript
export interface SessionMetadata {
  id: string;
  rootSessionId?: string; // Persisted in the session index
  sessionType: "main" | "subagent";
  subagentType?: string;
  workdir: string;
  lastActiveAt: Date;
  latestTotalTokens: number;
}
```

## Metadata Extraction Logic

- **ID**: Parsed from the filename (UUID).
- **Type**: Determined by the presence of the `subagent-` prefix.
- **Workdir**: Derived from the parent directory name (decoded).
- **LastActiveAt**: Extracted from the `timestamp` of the last line in the JSONL file.
- **LatestTotalTokens**: Extracted from the `usage` field of the last line in the JSONL file.
