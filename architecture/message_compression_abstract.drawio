<mxfile host="65bd71144e">
    <diagram name="消息压缩抽象图" id="message-compression-abstract">
        <mxGraphModel dx="1371" dy="849" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="2000" pageHeight="1200" math="0" shadow="0">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="scenario2-border" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#9673a6;strokeWidth=2;dashed=1;" parent="1" vertex="1">
                    <mxGeometry x="700" y="120" width="680" height="450" as="geometry"/>
                </mxCell>
                <mxCell id="scenario1-border" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#d6b656;strokeWidth=2;dashed=1;movable=1;resizable=1;rotatable=1;deletable=1;editable=1;locked=0;connectable=1;" parent="1" vertex="1">
                    <mxGeometry x="50" y="120" width="630" height="450" as="geometry"/>
                </mxCell>
                <mxCell id="title" value="消息压缩系统 - 处理流程与多级压缩" style="text;strokeColor=none;fillColor=none;html=1;fontSize=20;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="390" y="10" width="600" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="scenario1-title" value="场景1: 首次压缩 - 原始消息过多" style="text;strokeColor=none;fillColor=#fff2cc;html=1;fontSize=16;fontStyle=1;verticalAlign=middle;align=center;strokeColor=#d6b656;" parent="1" vertex="1">
                    <mxGeometry x="50" y="80" width="630" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="original-messages-title" value="原始消息列表" style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="70" y="125" width="120" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="msg1" value="用户消息 1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="70" y="160" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="msg2" value="助手消息 1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="70" y="200" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="msg-dots1" value="..." style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="70" y="240" width="90" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="msg-n-6" value="用户消息 n-6" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=2;" parent="1" vertex="1">
                    <mxGeometry x="70" y="270" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="msg-n-5" value="助手消息 n-5" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="70" y="310" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="msg-n-4" value="用户消息 n-4" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="70" y="350" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="msg-n-3" value="助手消息 n-3" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="70" y="390" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="msg-n-2" value="用户消息 n-2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="70" y="430" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="msg-n-1" value="助手消息 n-1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="70" y="470" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="msg-n" value="用户消息 n" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcccc;strokeColor=#ff0000;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="70" y="510" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="select-arrow1" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#ff6600;" parent="1" edge="1">
                    <mxGeometry width="50" height="50" relative="1" as="geometry">
                        <mxPoint x="180" y="240" as="sourcePoint"/>
                        <mxPoint x="280" y="240" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="select-label1" value="选择要压缩&#xa;的消息" style="text;strokeColor=#ff6600;fillColor=none;html=1;fontSize=10;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="190" y="200" width="70" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="compress-input-title1" value="发给压缩AI的消息" style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="300" y="125" width="140" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="compress-msg1" value="用户消息 1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="320" y="160" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="compress-msg2" value="助手消息 1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="320" y="200" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="compress-dots" value="..." style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="320" y="240" width="90" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="compress-msg-n-6" value="用户消息 n-6" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=3;" parent="1" vertex="1">
                    <mxGeometry x="320" y="270" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="compress-arrow1" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#ff6600;" parent="1" edge="1">
                    <mxGeometry width="50" height="50" relative="1" as="geometry">
                        <mxPoint x="430" y="240" as="sourcePoint"/>
                        <mxPoint x="500" y="240" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="compress-label1" value="压缩AI处理" style="text;strokeColor=#ff6600;fillColor=none;html=1;fontSize=10;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="430" y="210" width="70" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="result1-title" value="压缩后结果" style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="520" y="125" width="120" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="compress-block1" value="🗜️ 压缩消息块&lt;div&gt;&amp;nbsp;(替换消息1到n-6)&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="520" y="160" width="140" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="result-msg-n-5" value="助手消息 n-5" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="540" y="230" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="result-msg-n-4" value="用户消息 n-4" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="540" y="270" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="result-msg-n-3" value="助手消息 n-3" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="540" y="310" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="result-msg-n-2" value="用户消息 n-2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="540" y="350" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="result-msg-n-1" value="助手消息 n-1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="540" y="390" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="result-msg-n" value="用户消息 n" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcccc;strokeColor=#ff0000;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="540" y="430" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="scenario2-title" value="场景2: 二次压缩 - 已存在压缩块的情况" style="text;strokeColor=none;fillColor=#e1d5e7;html=1;fontSize=16;fontStyle=1;verticalAlign=middle;align=center;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="700" y="80" width="680" height="35" as="geometry"/>
                </mxCell>
                <mxCell id="existing-title" value="现有消息列表 (已含压缩块)" style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="720" y="125" width="180" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="old-compress-block" value="🗜️ 旧压缩块 (第1轮)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="740" y="160" width="120" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="existing-msg1" value="用户消息 A" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="750" y="220" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="existing-msg2" value="助手消息 A" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="750" y="260" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="existing-dots" value="..." style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="750" y="300" width="90" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="existing-msg-m-4" value="用户消息 m-4" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=2;" parent="1" vertex="1">
                    <mxGeometry x="750" y="330" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="existing-msg-m-3" value="助手消息 m-3" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="750" y="370" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="existing-msg-m-2" value="用户消息 m-2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="750" y="410" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="existing-msg-m-1" value="助手消息 m-1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="750" y="450" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="existing-msg-m" value="用户消息 m" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcccc;strokeColor=#ff0000;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="750" y="490" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="select-arrow2" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#ff6600;" parent="1" edge="1">
                    <mxGeometry width="50" height="50" relative="1" as="geometry">
                        <mxPoint x="870" y="280" as="sourcePoint"/>
                        <mxPoint x="950" y="280" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="select-label2" value="提取旧压缩+&#xa;新消息" style="text;strokeColor=#ff6600;fillColor=none;html=1;fontSize=10;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="870" y="235" width="80" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="compress-input-title2" value="发给压缩AI的消息" style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="970" y="125" width="140" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="old-compress-content" value="旧压缩块内容摘要" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="990" y="160" width="120" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="compress2-msg1" value="用户消息 A" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="1000" y="220" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="compress2-msg2" value="助手消息 A" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="1000" y="260" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="compress2-dots" value="..." style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="1000" y="300" width="90" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="compress2-msg-m-4" value="用户消息 m-4" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=3;" parent="1" vertex="1">
                    <mxGeometry x="1000" y="330" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="compress-arrow2" value="" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#ff6600;" parent="1" edge="1">
                    <mxGeometry width="50" height="50" relative="1" as="geometry">
                        <mxPoint x="1120" y="280" as="sourcePoint"/>
                        <mxPoint x="1200" y="280" as="targetPoint"/>
                    </mxGeometry>
                </mxCell>
                <mxCell id="compress-label2" value="压缩AI处理" style="text;strokeColor=#ff6600;fillColor=none;html=1;fontSize=10;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="1120" y="250" width="70" height="20" as="geometry"/>
                </mxCell>
                <mxCell id="result2-title" value="二次压缩结果" style="text;strokeColor=none;fillColor=none;html=1;fontSize=14;fontStyle=1;verticalAlign=middle;align=center;" parent="1" vertex="1">
                    <mxGeometry x="1220" y="125" width="120" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="new-compress-block" value="🗜️ 新压缩块&lt;div&gt;&amp;nbsp;(合并旧块+新消息)&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="1220" y="160" width="140" height="50" as="geometry"/>
                </mxCell>
                <mxCell id="final-msg-m-4" value="用户消息 m-4" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="1240" y="230" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="final-msg-m-3" value="助手消息 m-3" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="1240" y="270" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="final-msg-m-2" value="用户消息 m-2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="1240" y="310" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="final-msg-m-1" value="助手消息 m-1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
                    <mxGeometry x="1240" y="350" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="final-msg-m" value="用户消息 m" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcccc;strokeColor=#ff0000;fontStyle=1;" parent="1" vertex="1">
                    <mxGeometry x="1240" y="390" width="90" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="rules-title" value="压缩处理规则" style="text;strokeColor=none;fillColor=none;html=1;fontSize=16;fontStyle=1;verticalAlign=middle;align=left;" parent="1" vertex="1">
                    <mxGeometry x="70" y="600" width="150" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="rule1" value="1. 首次压缩：保留最后6条消息，将前面的消息发送给压缩AI生成摘要" style="text;strokeColor=none;fillColor=#fff2cc;html=1;fontSize=12;verticalAlign=middle;align=left;strokeColor=#d6b656;" parent="1" vertex="1">
                    <mxGeometry x="70" y="640" width="600" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="rule2" value="2. 二次压缩：提取旧压缩块内容和新消息，一起发送给压缩AI重新生成摘要" style="text;strokeColor=none;fillColor=#e1d5e7;html=1;fontSize=12;verticalAlign=middle;align=left;strokeColor=#9673a6;" parent="1" vertex="1">
                    <mxGeometry x="70" y="670" width="650" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="rule3" value="3. 压缩块处理：遇到压缩块时停止，提取摘要作为助手消息发送给对话AI" style="text;strokeColor=none;fillColor=#d5e8d4;html=1;fontSize=12;verticalAlign=middle;align=left;strokeColor=#82b366;" parent="1" vertex="1">
                    <mxGeometry x="70" y="700" width="620" height="25" as="geometry"/>
                </mxCell>
                <mxCell id="rule4" value="4. 多级压缩：可以进行多轮压缩，每次都保持最新的上下文完整性" style="text;strokeColor=none;fillColor=#f8cecc;html=1;fontSize=12;verticalAlign=middle;align=left;strokeColor=#b85450;" parent="1" vertex="1">
                    <mxGeometry x="70" y="730" width="580" height="25" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>